{{ request.user.is_psicologo|json_script:"user_is_psicologo" }}

<div class="table-responsive shadow-sm rounded-3 border">
    <table class="table table-borderless text-center mb-0">
        <tbody class="text-nowrap">
            {% for consulta in consultas %}
            <tr class="{% if not forloop.last %}border-bottom{% endif %}">
                <td class="text-start">
                    <div class="hstack gap-2">
                        <img class="rounded-circle object-fit-cover" style="width: 2.5em; height: 2.5em;" src="
                                {% if request.user.is_paciente %}
                                    {{ consulta.psicologo.get_url_foto_propria_ou_padrao }}
                                {% elif request.user.is_psicologo %}
                                    {{ consulta.paciente.get_url_foto_propria_ou_padrao }}
                                {% endif %}
                            " alt="Foto de perfil">

                        <span class="ms-2 text-wrap">
                            {% if request.user.is_paciente %}
                            {{ consulta.psicologo }}
                            {% elif request.user.is_psicologo %}
                            {{ consulta.paciente }}
                            {% endif %}
                        </span>
                    </div>
                </td>
                <td>
                    <span class="badge rounded-pill text-bg-{{ consulta.classe }}">
                        {{ consulta.get_estado_display }}
                    </span>
                </td>
                <td>{{ consulta.data_hora_agendada|date:"d/m/Y" }} às {{ consulta.data_hora_agendada|time }}</td>

                <td class="align-middle">
                    <div class="d-flex justify-content-end align-items-center gap-2" style="height:100%">

                        {% if request.user.is_paciente %}
                        {% with e=consulta.estado %}
                        {% if e != 'CANCELADA' and e != 'EM_ANDAMENTO' and e != 'FINALIZADA' %}
                        <form method="post" action="{% url 'consulta_cancelar' consulta.pk %}" class="d-inline m-0"
                            onsubmit="return confirm('Confirma cancelar esta consulta?');">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                            <button type="submit" class="btn btn-danger text-white btn-sm">Cancelar</button>
                        </form>
                        {% endif %}
                        {% endwith %}
                        {% endif %}

                        {% if request.user.is_psicologo and consulta.estado == 'SOLICITADA' %}
                        <form method="post" action="{% url 'consulta_aceitar' consulta.pk %}" class="d-inline m-0"
                            onsubmit="return confirm('Confirma aceitar esta consulta?');">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                            <button type="submit" class="btn btn-success btn-sm">Aceitar</button>
                        </form>

                        <form method="post" action="{% url 'consulta_cancelar' consulta.pk %}" class="d-inline m-0"
                            onsubmit="return confirm('Confirma cancelar esta consulta?');">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                            <button type="submit" class="btn btn-danger text-white btn-sm">Cancelar</button>
                        </form>
                        {% endif %}

                        {% if consulta.estado == 'EM_ANDAMENTO' %}
                        <a href="{{ consulta.jitsi_join_url }}" class="btn btn-primary btn-sm" target="_blank"
                            rel="noopener noreferrer">
                            Entrar na chamada
                        </a>
                        {% endif %}

                        {% if consulta.estado == 'FINALIZADA' %}

                        {% if request.user.is_paciente %}
                        <button data-bs-toggle="modal" data-bs-target="#checklistModal{{ consulta.pk }}"
                            class="btn btn-info btn-sm">
                            Checklist
                        </button>
                        <button data-bs-toggle="modal" data-bs-target="#anotacoesModal{{ consulta.pk }}"
                            class="btn btn-outline-warning btn-sm">
                            Ver Anotações
                        </button>

                        {% elif request.user.is_psicologo %}
                        <button data-bs-toggle="modal" data-bs-target="#checklistModal{{ consulta.pk }}"
                            class="btn btn-info btn-sm">
                            Checklist
                        </button>
                        <button data-bs-toggle="modal" data-bs-target="#anotacoesModal{{ consulta.pk }}"
                            class="btn btn-warning btn-sm">
                            Anotações
                        </button>
                        {% endif %}

                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% for consulta in consultas %}
{% if consulta.estado == 'FINALIZADA' %}
{% if consulta.checklist_tarefas or request.user.is_psicologo or request.user.is_paciente %}
<div class="modal fade" id="checklistModal{{ consulta.pk }}" tabindex="-1"
    aria-labelledby="checklistModalLabel{{ consulta.pk }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="checklistModalLabel{{ consulta.pk }}">
                    Checklist: {{ consulta.data_hora_agendada|date:"d/m/Y" }}
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {{ consulta.checklist_tarefas|json_script:consulta.pk }}
                <div id="checklist-container-{{ consulta.pk }}" class="vstack gap-2 mb-3">
                    <!-- Items will be rendered here -->
                </div>

                {% if request.user.is_psicologo %}
                <button type="button" class="btn btn-outline-primary btn-sm mb-3"
                    onclick="addChecklistItem('{{ consulta.pk }}')">
                    <i class="bi bi-plus-lg"></i> Adicionar Tarefa
                </button>
                {% endif %}

                <form method="post"
                    action="{% if request.user.is_paciente %}{% url 'consulta_checklist_paciente' consulta.pk %}{% else %}{% url 'consulta_checklist' consulta.pk %}{% endif %}"
                    onsubmit="return prepareChecklistSubmission('{{ consulta.pk }}')">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <input type="hidden" name="checklist_tarefas" id="checklist-input-{{ consulta.pk }}">

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-danger text-white"
                            data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>

                <script>
                    (function () {
                        const consultaId = '{{ consulta.pk }}';
                        const isPsicologo = JSON.parse(document.getElementById('user_is_psicologo').textContent);
                        const container = document.getElementById(`checklist-container-${consultaId}`);
                        const dataScript = document.getElementById(consultaId);
                        let checklistData = JSON.parse(dataScript.textContent) || [];

                        if (!Array.isArray(checklistData)) checklistData = [];

                        function render() {
                            container.innerHTML = '';
                            if (checklistData.length === 0) {
                                container.innerHTML = '<p class="text-muted text-center small">Nenhuma tarefa no checklist.</p>';
                                return;
                            }

                            checklistData.forEach((item, index) => {
                                const row = document.createElement('div');
                                row.className = 'card p-2';

                                if (isPsicologo) {
                                    row.innerHTML = `
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="Descrição da tarefa" value="${item.texto || ''}" onchange="updateItem(${consultaId}, ${index}, 'texto', this.value)">
                                            <button type="button" class="btn btn-outline-danger" onclick="removeChecklistItem('${consultaId}', ${index})"><i class="bi bi-trash"></i></button>
                                        </div>
                                        ${item.comentario ? `<div class="small text-muted mt-1 ms-1"><i class="bi bi-chat-left-text"></i> Paciente: ${item.comentario}</div>` : ''}
                                        ${item.feita ? '<div class="small text-success mt-1 ms-1"><i class="bi bi-check-circle-fill"></i> Concluída</div>' : ''}
                                    `;
                                } else {
                                    row.innerHTML = `
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="check-${consultaId}-${index}" ${item.feita ? 'checked' : ''} onchange="updateItem(${consultaId}, ${index}, 'feita', this.checked)">
                                            <label class="form-check-label fw-bold" for="check-${consultaId}-${index}">
                                                ${item.texto || 'Tarefa sem descrição'}
                                            </label>
                                        </div>
                                        <input type="text" class="form-control form-control-sm mt-2" placeholder="Comentário (opcional)" value="${item.comentario || ''}" onchange="updateItem(${consultaId}, ${index}, 'comentario', this.value)">
                                    `;
                                }
                                container.appendChild(row);
                            });
                        }

                        window.checklistRegistry = window.checklistRegistry || {};
                        window.checklistRegistry[consultaId] = {
                            data: checklistData,
                            render: render
                        };

                        render();
                    })();
                </script>
            </div>
        </div>
    </div>
</div>
{% endif %}


<div class="modal fade" id="anotacoesModal{{ consulta.pk }}" tabindex="-1"
    aria-labelledby="anotacoesModalLabel{{ consulta.pk }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="anotacoesModalLabel{{ consulta.pk }}">
                    Anotações: {{ consulta.data_hora_agendada|date:"d/m/Y" }}
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if request.user.is_psicologo %}
                <form method="post" action="{% url 'consulta_anotacoes' consulta.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <div class="mb-3">
                        <label for="anotacoes_{{ consulta.pk }}" class="visually-hidden">Anotações</label>
                        <textarea id="anotacoes_{{ consulta.pk }}" name="anotacoes" class="form-control" rows="10"
                            placeholder="Escreva as anotações desta consulta (observações clínicas, progressos, histórico...)">{{ consulta.anotacoes|default:"" }}</textarea>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-danger text-white"
                            data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
                {% else %}
                <div class="mb-3">
                    <label class="form-label fw-bold">Anotações do Psicólogo:</label>
                    <div class="p-3 bg-light border rounded" style="white-space: pre-wrap;">
                        {{ consulta.anotacoes|default:"Nenhuma anotação disponível." }}
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<script>
    window.checklistRegistry = window.checklistRegistry || {};

    window.addChecklistItem = function (consultaId) {
        const registry = window.checklistRegistry[consultaId];
        if (!registry) return;
        registry.data.push({ texto: '', feita: false, comentario: '' });
        registry.render();
    }

    window.removeChecklistItem = function (consultaId, index) {
        const registry = window.checklistRegistry[consultaId];
        if (!registry) return;
        registry.data.splice(index, 1);
        registry.render();
    }

    window.updateItem = function (consultaId, index, field, value) {
        const registry = window.checklistRegistry[consultaId];
        if (!registry) return;
        registry.data[index][field] = value;
    }

    window.prepareChecklistSubmission = function (consultaId) {
        const registry = window.checklistRegistry[consultaId];
        if (!registry) return false;
        document.getElementById(`checklist-input-${consultaId}`).value = JSON.stringify(registry.data);
        return true;
    }
</script>
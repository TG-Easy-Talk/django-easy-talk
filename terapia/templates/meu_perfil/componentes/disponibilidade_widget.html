<!-- django-easy-talk/terapia/templates/meu_perfil/componentes/disponibilidade_widget.html -->
{% load static %}

<div class="d-flex justify-content-between align-items-center mt-3">
    <button type="button" id="prev-week" class="btn btn-outline-primary">&laquo;</button>
    <span id="week-label">Semana {{ week_offset }}</span>
    <button type="button" id="next-week" class="btn btn-outline-primary">&raquo;</button>
</div>

<style>
    .grade-intervalos {
        display: grid;
        grid-template-columns: repeat(25, 1fr);
    }

    .grade-intervalos > *[data-grade] {
        min-height: 1rem;
        cursor: pointer;
    }

    .prevent-select {
        -webkit-user-select: none; /* Safari */
        -ms-user-select: none; /* IE 10+ */
        user-select: none; /* Standard */
    }
</style>

<div draggable="false" class="grade-intervalos mt-5">
    {% for _ in "1234567" %}
        <div draggable="false" class="text-end font-monospace me-3">
            {% if forloop.counter|divisibleby:"7" %}Sáb
            {% elif forloop.counter|divisibleby:"6" %}Sex
            {% elif forloop.counter|divisibleby:"5" %}Qui
            {% elif forloop.counter|divisibleby:"4" %}Qua
            {% elif forloop.counter|divisibleby:"3" %}Ter
            {% elif forloop.counter|divisibleby:"2" %}Seg
            {% else %}Dom{% endif %}
        </div>

        {% for _ in "123456789012345678901234" %}
            <div
                    data-grade
                    data-selecionado="false"
                    data-linha="{{ forloop.parentloop.counter0 }}"
                    data-coluna="{{ forloop.counter0 }}"
                    class="position-relative border-bottom border-primary
               {% if forloop.parentloop.first %}border-top{% endif %}
               {% if forloop.first %}border-start{% endif %}
               border-end"
            >
                {% if forloop.parentloop.first %}
                    <div
                            draggable="false"
                            class="font-monospace position-absolute translate-middle"
                            style="top: -100%; cursor: default;"
                    >
                        {{ forloop.counter0 }}h
                    </div>

                    {% if forloop.last %}
                        <div
                                draggable="false"
                                class="font-monospace position-absolute translate-middle start-100"
                                style="top: -100%; cursor: default;"
                        >
                            {{ forloop.counter }}h
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        {% endfor %}
    {% endfor %}
</div>

<div class="d-flex justify-content-end gap-3">
    <a type="button" class="link-primary" onclick="DisponibilidadeWidget.limparGrade()">Limpar grade</a>
    <a type="button" class="link-primary" onclick="DisponibilidadeWidget.redefinir()">Redefinir</a>
</div>

<input type="hidden" name="disponibilidade" value="{{ widget.value }}"/>
<input type="hidden" name="week_offset" id="week_offset" value="{{ week_offset }}"/>

<div class="text-body-secondary">Sua tabela de disponibilidade ficará assim:</div>
{% include 'geral/tabela_disponibilidade.html' with matriz_disponibilidade_booleanos=widget.value week_offset=week_offset %}

<script>
    class DisponibilidadeWidget {
        static widget = document.querySelector('input[name="disponibilidade"]');
        static celulas = document.querySelectorAll('[data-grade]');
        static classesNaoSelecionado = ["bg-body-secondary"];
        static classesSelecionado = ["bg-secondary"];
        static matriz = {{ widget.value }};
        static original = {{ widget.value }};

        static atualizarItem(item) {
            const l = +item.dataset.linha, c = +item.dataset.coluna;
            if (this.matriz[l][c]) this.selecionar(item);
            else this.tirar(item);
        }

        static selecionar(item) {
            item.dataset.selecionado = "true";
            this.classesNaoSelecionado.forEach(c => item.classList.remove(c));
            this.classesSelecionado.forEach(c => item.classList.add(c));
        }

        static tirar(item) {
            item.dataset.selecionado = "false";
            this.classesSelecionado.forEach(c => item.classList.remove(c));
            this.classesNaoSelecionado.forEach(c => item.classList.add(c));
        }

        static toggle(item) {
            (item.dataset.selecionado === "false" ? this.selecionar : this.tirar).call(this, item);
            const l = +item.dataset.linha, c = +item.dataset.coluna;
            this.matriz[l][c] = item.dataset.selecionado === "true";
            this.updateAll();
        }

        static limparGrade() {
            this.matriz = this.matriz.map(row => row.map(_ => false));
            this.updateAll();
        }

        static redefinir() {
            this.matriz = this.original.map(r => [...r]);
            this.updateAll();
        }

        static lidar(e, item) {
            if (e.buttons === 1) this.toggle(item);
        }

        static preparar() {
            this.celulas.forEach(item => {
                item.classList.add('prevent-select');
                item.addEventListener('dragstart', e => e.preventDefault());
                this.atualizarItem(item);
                item.addEventListener('mousedown', e => this.lidar(e, item));
                item.addEventListener('mouseover', e => this.lidar(e, item));
            });
            this.widget.value = JSON.stringify(this.original);
            document.getElementById('prev-week').onclick = () => this.changeWeek(-1);
            document.getElementById('next-week').onclick = () => this.changeWeek(1);
        }

        static changeWeek(delta) {
            let w = +document.getElementById('week_offset').value;
            w += delta;
            const p = new URLSearchParams(window.location.search);
            p.set('week', w);
            window.location.search = p.toString();
        }

        static updateAll() {
            this.widget.value = JSON.stringify(this.matriz);
            DisponibilidadeTabela.matriz_disponibilidade_booleanos = this.matriz;
            DisponibilidadeTabela.atualizar();
        }
    }

    DisponibilidadeWidget.preparar();
</script>

<header id="cabecalho"
class="navbar {% if request.user.is_anonymous %} navbar-expand-lg {% else %} navbar-expand-sm {% endif %} text-bg-dark fixed-top shadow">
    <div class="container-fluid">

        <a class="navbar-brand font-family-easytalk-logo" href="{% url 'home' %}">EasyTalk</a>
        
        <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="navbarCabecalho"
            aria-labelledby="navbarCabecalhoLabel">
            <div class="offcanvas-header">
                <a class="offcanvas-title navbar-brand font-family-easytalk-logo" href="{% url 'pesquisa' %}">EasyTalk</a>
                <i class="bi bi-x fs-2 ms-auto" role="button" data-bs-dismiss="offcanvas" aria-label="Fechar"></i>
            </div>
            <div class="offcanvas-body">
                <ul class="navbar-nav my-2 justify-content-end flex-grow-1
                    {% if request.user.is_anonymous %} align-items-lg-center {% else %} align-items-sm-center {% endif %}"
                >
                    {% if request.user.is_anonymous %}
                        {% include 'geral/nav_items_compartilhados.html' %}
                        <li class="nav-item">
                            <a type="button" class="btn text-white btn-secondary me-lg-3 mt-3 mt-lg-0 w-100 w-lg-auto rounded-3"
                                href="{% url 'login' %}">Entrar</a>
                            <a type="button"
                                class="btn text-white btn-primary mt-3 mt-lg-0 w-100 w-lg-auto rounded-3"
                                href="{% url 'cadastro_escolha' %}">Cadastrar-se</a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link me-lg-5 text-nowrap" href="{% url 'pesquisa' %}">Profissionais</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link me-lg-0 text-nowrap" href="{% url 'minhas_consultas' %}">Minhas consultas</a>
                        </li>
                        {% if request.user.is_psicologo %}
                            <li class="nav-item">
                                <a class="nav-link ms-lg-5 text-nowrap position-relative" href="{% url 'meu_perfil_info_profissional' %}">
                                    Meu perfil
                                </a>
                            </li>
                        {% endif %}
                        <li class="nav-item">
                            <a class="d-block d-sm-none nav-link me-lg-5 text-nowrap text-warning" href="#" onclick="logout()">Encerrar sessão</a>
                        </li>
                        <li class="nav-item m-0 mx-lg-4">
                            <style>
                                .notificacoes-popover {
                                    max-height: 50vh;
                                    overflow-y: auto;
                                }
                            </style>
                            <button id="notificationBell" class="btn btn-dark position-relative" type="button"
                                data-bs-toggle="popover" data-bs-html="true" data-bs-placement="bottom"
                                data-bs-custom-class="notificacoes-popover"
                                aria-label="Notificações" data-bs-title="Notificações">
                                <i class="bi bi-bell-fill fs-4" style="color: yellow;"></i>
                                {% if request.user.tem_notificacao_nao_lida %}
                                    <span class="top-0 end-0 position-absolute p-1 bg-danger border border-light rounded-circle">
                                        <span class="visually-hidden">Novas notificações</span>
                                    </span>
                                {% endif %}
                            </button>

                            <div id="notifications-template" class="d-none p-0">
                                {% for n in request.user.notificacoes_como_destinatario.all %}
                                    <div class="text-muted small mb-1">
                                        {% if not n.lida %}
                                            <span class="badge rounded-pill text-bg-secondary me-2">Nova</span>
                                        {% endif %}
                                        Recebida em {{ n.data_hora_criada|date:"d/m/Y H:i" }}
                                    </div>
                                    <div>{{ n.mensagem }}</div>
                                    {% if not forloop.last %}<hr>{% endif %}
                                {% empty %}
                                    <div class="p-2 text-muted">Sem notificações.</div>
                                {% endfor %}
                            </div>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
        {% if request.user.is_anonymous %}
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="offcanvas"
                data-bs-target="#navbarCabecalho" aria-controls="navbarCabecalho"
                aria-label="Alternar navegação">
                <span class="navbar-toggler-icon"></span>
            </button>
        {% else %}
            <div class="navbar-nav">
                <div class="nav-item hstack d-sm-none" role="button" data-bs-toggle="offcanvas" data-bs-target="#navbarCabecalho">
                    {% include 'geral/cabecalho/componentes/usuario.html' %}
                </div>

                <div class="nav-item d-none d-sm-block dropdown">
                    <button class="btn btn-dark hstack fw-normal border-0" type="button" data-bs-toggle="dropdown" aria-expanded="false"
                    style="--bs-btn-hover-bg: null; --bs-btn-active-bg: null;
                    --bs-btn-hover-color: var(--bs-secondary); --bs-btn-active-color: var(--bs-secondary);">
                        {% include 'geral/cabecalho/componentes/usuario.html' %}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'login' %}">Mudar de conta</a></li>
                        <li><div class="dropdown-item" type="button" onclick="logout()">Encerrar sessão</div></li>
                    </ul>
                </div>
            </div>
        {% endif %}
    </div>
</header>


{# Formulário para fazer logout do usuário (é necessário porque a LogoutView do Django só aceita POST) #}
<form id="logout-form" action="{% url 'logout' %}" method="post" class="d-none">
    {% csrf_token %}
</form>

<script>
    function logout() {
        document.getElementById('logout-form').submit();
    }
</script>



{# Espaço para o cabeçalho fixo #}
<div id="cabecalhoEspaco"></div>

<script>
    const cabecalhoEspaco = document.getElementById('cabecalhoEspaco');
    const cabecalho = document.getElementById('cabecalho');

    function setHeightCabecalhoEspaco() {
        cabecalhoEspaco.style.height = `${cabecalho.offsetHeight}px`;
    }

    setHeightCabecalhoEspaco();
    window.addEventListener('resize', setHeightCabecalhoEspaco);
</script>

<script>
    // Inicializa o popover quando o DOM estiver pronto (garante que o bundle Bootstrap carregado com `defer` já esteja disponível)
    document.addEventListener('DOMContentLoaded', function(){
        // Inicializa o popover do sino de notificações
        const bell = document.getElementById('notificationBell')
        if(!bell) return

        const template = document.getElementById('notifications-template')

        function getPopoverContent(){
            return template.innerHTML
        }

        const pop = new bootstrap.Popover(bell, {
            content: getPopoverContent,
            sanitize: false,
            trigger: 'focus',
            container: 'body'
        })

        bell.addEventListener('shown.bs.popover', function(){
            // Marca todas as notificações como lidas quando o popover é exibido
            fetch('{% url "marcar_notificacoes_como_lidas" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
        })
    })
</script>